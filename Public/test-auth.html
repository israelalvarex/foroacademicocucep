<!DOCTYPE html>
<html>
<head>
    <title>Test de AutenticaciÃ³n</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { margin: 5px; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        #result { margin-top: 20px; padding: 10px; background: #f5f5f5; border: 1px solid #ddd; max-height: 500px; overflow-y: auto; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test de AutenticaciÃ³n - Foro AcadÃ©mico</h1>
    
    <div>
        <button onclick="testServer()">ğŸ–¥ï¸ Test Servidor</button>
        <button onclick="testToken()">ğŸ”‘ Test Token</button>
        <button onclick="testAuth()">ğŸ” Test AutenticaciÃ³n</button>
        <button onclick="testAdmin()">ğŸ‘‘ Test Admin/Profesor</button>
        <button onclick="testCreateForum()">ğŸ“ Test Crear Foro</button>
        <button onclick="clearSession()">ğŸ§¹ Limpiar SesiÃ³n</button>
        <button onclick="goToLogin()">ğŸšª Ir a Login</button>
    </div>
    
    <div id="result"></div>
    
    <script src="js/api.js"></script>
    <script>
        const api = window.api || new ApiService();
        const resultDiv = document.getElementById('result');
        
        function log(msg, type = 'info') {
            console.log(msg);
            const p = document.createElement('p');
            p.className = type;
            p.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            resultDiv.appendChild(p);
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }
        
        async function testServer() {
            log('ğŸ–¥ï¸ Probando conexiÃ³n con el servidor...', 'info');
            try {
                const response = await fetch('/diagnostico');
                const data = await response.json();
                log(`âœ… Servidor ONLINE`, 'success');
                log(`ğŸ“Š Status: ${data.server.status}`, 'info');
                log(`â° Uptime: ${data.server.uptime}s`, 'info');
                log(`ğŸ” JWT_SECRET: ${data.environment.JWT_SECRET}`, 'info');
                log(`ğŸ—„ï¸ DB: ${data.environment.DB_NAME}`, 'info');
            } catch (error) {
                log(`âŒ Error conectando al servidor: ${error.message}`, 'error');
            }
        }
        
        async function testToken() {
            log('ğŸ” Examinando token en localStorage...', 'info');
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (!token) {
                log('âŒ NO hay token en localStorage', 'error');
                return;
            }
            
            log(`âœ… Token encontrado (${token.length} caracteres)`, 'success');
            log(`ğŸ”‘ Token preview: ${token.substring(0, 30)}...`, 'info');
            
            try {
                const parts = token.split('.');
                if (parts.length === 3) {
                    const payload = JSON.parse(atob(parts[1]));
                    log(`âœ… Token JWT vÃ¡lido`, 'success');
                    log(`ğŸ‘¤ ID: ${payload.id}`, 'info');
                    log(`ğŸ“§ Email: ${payload.email}`, 'info');
                    log(`ğŸ­ Rol: ${payload.rol}`, 'info');
                    log(`â° Expira: ${new Date(payload.exp * 1000).toLocaleString()}`, 'info');
                    log(`â³ Restante: ${Math.floor((payload.exp * 1000 - Date.now()) / 60000)} minutos`, 'info');
                } else {
                    log('âš ï¸ Token no tiene formato JWT estÃ¡ndar', 'warning');
                }
            } catch (e) {
                log(`âŒ Error decodificando token: ${e.message}`, 'error');
            }
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    log(`ğŸ‘¤ Datos de usuario: ${userData.nombre} (${userData.email})`, 'info');
                } catch (e) {
                    log('âŒ Error parseando datos de usuario', 'error');
                }
            }
        }
        
        async function testAuth() {
            log('ğŸ” Probando autenticaciÃ³n con el servidor...', 'info');
            try {
                const response = await api.request('/foros/test-auth');
                log(`âœ… AutenticaciÃ³n EXITOSA`, 'success');
                log(`ğŸ‘¤ Usuario autenticado: ${response.user.email} (Rol: ${response.user.rol})`, 'info');
            } catch (error) {
                log(`âŒ Error de autenticaciÃ³n: ${error.message}`, 'error');
                log(`ğŸ” Detalles: ${JSON.stringify(error)}`, 'error');
            }
        }
        
        async function testAdmin() {
            log('ğŸ‘‘ Probando permisos de admin/profesor...', 'info');
            try {
                const response = await api.request('/foros/test-admin');
                log(`âœ… Permisos CONFIRMADOS`, 'success');
                log(`ğŸ­ Rol del usuario: ${response.user.rol}`, 'info');
            } catch (error) {
                log(`âŒ Error de permisos: ${error.message}`, 'error');
                log(`ğŸ” Este usuario NO tiene permisos de admin/profesor`, 'error');
            }
        }
        
        async function testCreateForum() {
            log('ğŸ“ Probando creaciÃ³n de foro...', 'info');
            
            // Obtener usuario actual
            const userData = api.getUserData();
            log(`ğŸ‘¤ Usuario actual ID: ${userData?.id || 'No encontrado'}`, 'info');
            
            if (!userData?.id) {
                log('âŒ No hay usuario logueado', 'error');
                return;
            }
            
            const forumData = {
                titulo: "Foro de Prueba - " + new Date().toLocaleTimeString(),
                descripcion: "Este es un foro de prueba creado desde el test de autenticaciÃ³n",
                categoria_id: 1,
                tipo: "discusion",
                etiquetas: ["prueba", "test", "autenticacion"],
                privado: false,
                usuario_id: userData.id
            };
            
            log(`ğŸ“¦ Datos a enviar:`, 'info');
            log(JSON.stringify(forumData, null, 2), 'info');
            
            try {
                const response = await api.request('/foros', {
                    method: 'POST',
                    body: forumData
                });
                log(`âœ… FORO CREADO EXITOSAMENTE`, 'success');
                log(`ğŸ“ ID del foro: ${response.foro?.id}`, 'info');
                log(`ğŸ·ï¸ TÃ­tulo: ${response.foro?.nombre}`, 'info');
                log(`ğŸ“… Creado: ${new Date(response.foro?.fecha_creacion).toLocaleString()}`, 'info');
            } catch (error) {
                log(`âŒ ERROR creando foro: ${error.message}`, 'error');
                log(`ğŸ” Detalles completos: ${JSON.stringify(error, null, 2)}`, 'error');
            }
        }
        
        function clearSession() {
            log('ğŸ§¹ Limpiando sesiÃ³n...', 'info');
            api.limpiarSesion();
            log('âœ… SesiÃ³n limpiada. Token y datos de usuario eliminados.', 'success');
        }
        
        function goToLogin() {
            log('ğŸšª Redirigiendo a login...', 'info');
            window.location.href = '/login.html';
        }
        
        // Auto-test al cargar la pÃ¡gina
        window.addEventListener('load', () => {
            log('ğŸ“‹ Test de AutenticaciÃ³n - Foro AcadÃ©mico', 'info');
            log('ğŸ” Pulsa los botones para realizar pruebas', 'info');
            testServer();
        });
    </script>
</body>
</html>